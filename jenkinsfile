pipeline {
  agent any
  stages {
    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/GRISE-UPM/PROF-2023-Ejercicio4.git'
      }
    }
    stage('Backup') {
      steps {
        sh 'sqlite3 Employees < sqlite.sql'
      }
    }
    stage('Drop') {
      steps {
        sh 'echo "DROP DATABASE IF EXISTS Employees;" | sqlite3'
      }
    }
    stage('Create') {
      steps {
        sh 'sqlite3 < sqlite.sql'
      }
    }
    stage('Restore') {
      steps {
        sh 'sqlite3 Employees < backup.sql'
      }
    }
    stage('Status Check') {
      steps {
        script {
          def status = sh(returnStdout: true, script: 'sqlite3 Employees "SELECT COUNT(*) FROM employees;"').trim()
          if (status == '0') {
            status = 'FAILED'
          } else {
            status = 'SUCCESS'
          }
          step([
            $class: 'GitHubCommitStatusSetter',
            commitSha: env.GIT_COMMIT,
            status: status,
            context: 'Database maintenance'
          ])
        }
      }
    }
  }
}
